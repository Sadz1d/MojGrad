<!-- components/problem-report-form/problem-report-form.component.html -->
<div class="form-container">
  <!-- Pozadinska slika sa overlay-em -->
  <div class="form-overlay"></div>
  
  <div class="form-content">
    <!-- Logo & Brand -->
    <div class="form-brand">
      <div class="brand-logo-container">
        <img src="/assets/images/logo1.png" alt="Moj Grad Logo" class="brand-logo">
      </div>
      <h1 class="brand-name">Moj Grad</h1>
      <p class="brand-tagline">{{ isEditMode ? 'Izmijenite prijavu problema' : 'Prijavite problem i pomozite svom gradu' }}</p>
    </div>

     <!-- Poruka ako korisnik nije prijavljen -->
    <div *ngIf="!isAuthenticated && !isEditMode" class="alert alert-warning">
      <mat-icon>warning</mat-icon>
      Morate biti prijavljeni da biste kreirali novu prijavu. 
      <a [routerLink]="['/auth/login']" [queryParams]="{ returnUrl: router.url }">Prijavite se ovdje</a>
    </div>

    <!-- Form Card -->
    <div class="form-card-wrapper">
      <!-- Success Message -->
      <div *ngIf="successMessage" class="alert alert-success">
        {{ successMessage }}
      </div>

      <!-- Loading State -->
      <div *ngIf="loading" class="loading-container">
        <div class="loading-spinner"></div>
        <p>Učitavanje podataka...</p>
      </div>

      <!-- Error Message -->
      <div *ngIf="error && !loading" class="alert alert-danger">
        {{ error }}
      </div>

      <!-- Prikaži ko je trenutno prijavljen -->
      <div *ngIf="isAuthenticated && !isEditMode" class="user-info">
        <mat-icon>person</mat-icon>
        <span>Prijavljujete problem kao: <strong>{{ currentUserFullName }}</strong></span>
      </div>

      <!-- Form -->
      <form [formGroup]="form" (ngSubmit)="onSubmit()" *ngIf="!loading" class="form-card">
        <div class="form-header">
          <div class="form-title-badge">{{ isEditMode ? 'IZMJENA PRIJAVE' : 'NOVA PRIJAVA' }}</div>
          <h2 class="form-title">{{ isEditMode ? 'Izmijenite prijavu problema' : 'Kreirajte novu prijavu' }}</h2>
          <p class="form-subtitle">
            {{ isEditMode ? 
              'Ažurirajte podatke o postojećoj prijavi.' : 
              'Popunite formular kako biste prijavili problem u gradu.' 
            }}
          </p>
        </div>

        <!-- Title -->
        <div class="form-group">
          <label for="title" class="form-label">
            <mat-icon class="field-icon">title</mat-icon>
            Naslov problema *
          </label>
          <input type="text" id="title" class="form-control" formControlName="title"
                 placeholder="Npr. 'Nepokošena trava u parku'"
                 [class.is-invalid]="getFieldError('title')">
          <div class="error-message" *ngIf="getFieldError('title')">
            <mat-icon>error_outline</mat-icon>
            {{ getFieldError('title') }}
          </div>
        </div>

        <!-- Description -->
        <div class="form-group">
          <label for="description" class="form-label">
            <mat-icon class="field-icon">description</mat-icon>
            Detaljan opis *
          </label>
          <textarea id="description" class="form-control" rows="4" formControlName="description"
                    placeholder="Opišite problem što detaljnije..."
                    [class.is-invalid]="getFieldError('description')"></textarea>
          <div class="error-message" *ngIf="getFieldError('description')">
            <mat-icon>error_outline</mat-icon>
            {{ getFieldError('description') }}
          </div>
          <div class="form-hint">
            <mat-icon>info</mat-icon>
            Maksimalno 2000 karaktera.
          </div>
        </div>

        <!-- Image -->
        <div class="form-group">
          <label for="image" class="form-label">
            <mat-icon class="field-icon">image</mat-icon>
            Slika (opciono)
          </label>
          <input type="file"
       accept="image/*"
       (change)="onFileSelected($event)">

<img
    *ngIf="imagePreview"
    [src]="imagePreview"
    alt="Slika prijave"
    style="max-width: 100%; border-radius: 8px;"
/>

<mat-progress-bar
  *ngIf="progress > 0"
  mode="determinate"
  [value]="progress">
</mat-progress-bar>

          <div class="error-message" *ngIf="getFieldError('image')">
            <mat-icon>error_outline</mat-icon>
            {{ getFieldError('image') }}
          </div>
        </div>

        <!-- Location -->
        <div class="form-group">
          <label for="location" class="form-label">
            <mat-icon class="field-icon">location_on</mat-icon>
            Lokacija
          </label>
          <input type="text" id="location" class="form-control" formControlName="location"
                 placeholder="Npr. 'Park Zrinjevac, ulaz sa sjeverne strane'"
                 [class.is-invalid]="getFieldError('location')">
          <div class="error-message" *ngIf="getFieldError('location')">
            <mat-icon>error_outline</mat-icon>
            {{ getFieldError('location') }}
          </div>
          <div class="form-hint">
            <mat-icon>info</mat-icon>
            Maksimalno 200 karaktera.
          </div>
        </div>

        <!-- Category Dropdown -->
        <div class="form-group">
          <label for="category" class="form-label">
            <mat-icon class="field-icon">category</mat-icon>
            Kategorija *
          </label>
          
          <!-- Loading state -->
          <div *ngIf="loadingCategories" class="loading-dropdown">
            <mat-spinner diameter="20"></mat-spinner>
            <span>Učitavanje kategorija...</span>
          </div>
          
          <!-- Dropdown za kategorije -->
          <select 
            id="category" 
            class="form-control select-control"
            [class.is-invalid]="getFieldError('categoryId')"
            (change)="onCategoryChange($event)"
            [disabled]="loadingCategories">
            
            <option value="" disabled selected>Odaberite kategoriju...</option>
            <option *ngFor="let category of categories" [value]="category.id">
              {{ category.name }}
              <span *ngIf="category.description"> - {{ category.description }}</span>
            </option>
          </select>
          
          <!-- Hidden input za categoryId -->
          <input type="hidden" formControlName="categoryId">
          <input type="hidden" formControlName="categoryName">
          
          <div class="error-message" *ngIf="getFieldError('categoryId')">
            <mat-icon>error_outline</mat-icon>
            {{ getFieldError('categoryId') }}
          </div>
          
          <div class="form-hint" *ngIf="!loadingCategories">
            <mat-icon>info</mat-icon>
            Odaberite kategoriju problema ({{ categories.length }} dostupno)
          </div>
          
          <div class="error-message" *ngIf="categories.length === 0 && !loadingCategories">
            <mat-icon>error</mat-icon>
            Nema dostupnih kategorija. Molimo kontaktirajte administratora.
          </div>
        </div>

        <!-- Status Dropdown -->
        <div class="form-group">
          <label for="status" class="form-label">
            <mat-icon class="field-icon">flag</mat-icon>
            Status *
          </label>
          
          <!-- Loading state -->
          <div *ngIf="loadingStatuses" class="loading-dropdown">
            <mat-spinner diameter="20"></mat-spinner>
            <span>Učitavanje statusa...</span>
          </div>
          
          <!-- Dropdown za statuse -->
          <select 
            id="status" 
            class="form-control select-control"
            [class.is-invalid]="getFieldError('statusId')"
            (change)="onStatusChange($event)"
            [disabled]="loadingStatuses">
            
            <option value="" disabled selected>Odaberite status...</option>
            <option *ngFor="let status of statuses" [value]="status.id">
              {{ status.name }}
              <span *ngIf="status.description"> - {{ status.description }}</span>
            </option>
          </select>
          
          <!-- Hidden input za statusId -->
          <input type="hidden" formControlName="statusId">
          <input type="hidden" formControlName="statusName">
          
          <div class="error-message" *ngIf="getFieldError('statusId')">
            <mat-icon>error_outline</mat-icon>
            {{ getFieldError('statusId') }}
          </div>
          
          <div class="form-hint" *ngIf="!loadingStatuses">
            <mat-icon>info</mat-icon>
            Odaberite status prijave ({{ statuses.length }} dostupno)
          </div>
          
          <div class="error-message" *ngIf="statuses.length === 0 && !loadingStatuses">
            <mat-icon>error</mat-icon>
            Nema dostupnih statusa. Molimo kontaktirajte administratora.
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" class="form-button form-button-secondary" 
                  (click)="router.navigate(['/problem-reports'])">
            <mat-icon>arrow_back</mat-icon>
            Nazad na listu
          </button>
          
          <button type="submit" class="form-button form-button-primary" 
                  [disabled]="submitting || form.invalid || loadingCategories || loadingStatuses">
            <mat-icon *ngIf="!submitting">{{ isEditMode ? 'save' : 'send' }}</mat-icon>
            <mat-spinner *ngIf="submitting" diameter="20"></mat-spinner>
            {{ isEditMode ? 'Sačuvaj izmjene' : 'Pošalji prijavu' }}
          </button>
        </div>
      </form>
    </div>

    <!-- Footer -->
    <div class="form-footer">
      <p class="platform-description">
        Prijavite problem, pomozite svojim sugrađanima<br>
        unaprijedite naš grad.
      </p>
    </div>
  </div>
</div>